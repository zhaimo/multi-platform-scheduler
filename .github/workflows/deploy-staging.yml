name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.your-domain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push images
        run: |
          # Backend
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:staging \
            -f ./multi-platform-scheduler/backend/Dockerfile.prod \
            ./multi-platform-scheduler/backend
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:staging
          
          # Worker
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-worker:staging \
            -f ./multi-platform-scheduler/backend/Dockerfile.worker \
            ./multi-platform-scheduler/backend
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-worker:staging
          
          # Frontend
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:staging \
            -f ./multi-platform-scheduler/frontend/Dockerfile.prod \
            ./multi-platform-scheduler/frontend
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:staging
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to staging server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          ssh -i ~/.ssh/staging_key $STAGING_USER@$STAGING_HOST << 'EOF'
            cd /opt/video-scheduler
            
            # Pull latest images
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:staging
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-worker:staging
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:staging
            
            # Update docker-compose to use new images
            export BACKEND_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:staging
            export WORKER_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-worker:staging
            export FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:staging
            
            # Run database migrations
            docker-compose -f docker-compose.staging.yml exec -T backend alembic upgrade head
            
            # Restart services with zero downtime
            docker-compose -f docker-compose.staging.yml up -d --no-deps backend
            docker-compose -f docker-compose.staging.yml up -d --no-deps celery-worker
            docker-compose -f docker-compose.staging.yml up -d --no-deps frontend
            
            # Clean up old images
            docker image prune -f
          EOF
      
      - name: Health check
        run: |
          sleep 30
          curl -f https://staging.your-domain.com/health || exit 1
      
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
